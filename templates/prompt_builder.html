<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO Content Generator - Prompt Builder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f7f7fa; }
        .header { background: #1E2E66; color: #fff; padding: 1.5rem 2rem; margin-bottom: 2rem; }
        .section { background: #eaf3fb; border-radius: 8px; padding: 2rem; margin-bottom: 2rem; border: 1px solid #d0d7e5; }
        .accent-btn { background: #1E2E66; color: #fff; font-weight: bold; }
        .accent-btn:hover { background: #16204a; color: #fff; }
        .form-label { font-weight: 500; }
        .section-title { color: #1E2E66; font-weight: bold; margin-bottom: 1rem; border-bottom: 2px solid #1E2E66; padding-bottom: 0.5rem; }
        .prompt-output { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 1.5rem; margin-top: 2rem; }
        .copy-btn { position: absolute; top: 10px; right: 10px; }
        .prompt-container { position: relative; }
        .nav-btn { margin: 0 0.5rem; }
        
        /* Live Preview Layout */
        .live-preview-container {
            position: sticky;
            top: 20px;
            height: fit-content;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .live-preview {
            background: #f8f9fa;
            color: #000;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
            min-height: 200px;
        }
        
        .preview-title {
            color: #1E2E66;
            font-weight: bold;
            margin-bottom: 1rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .copy-preview-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #1E2E66;
            border: 1px solid #1E2E66;
            color: white;
        }
        
        .copy-preview-btn:hover {
            background: #16204a;
            color: white;
        }
        
        /* Question Form Styling */
        .question-form-container {
            padding-right: 1rem;
        }
        
        @media (max-width: 991px) {
            .question-form-container {
                padding-right: 0;
                margin-bottom: 2rem;
            }
            
            .live-preview-container {
                position: static;
                max-height: none;
            }
        }
        
        /* Speech Recognition Styles */
        .input-group .btn {
            border-left: 0;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        #speechStatus {
            transition: all 0.3s ease;
        }
        
        #speechBtn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #speechBtn.btn-danger {
            animation: recording-pulse 2s infinite;
        }
        
        @keyframes recording-pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        
        /* Mini speech buttons for questions */
        .speech-btn-mini {
            padding: 0.375rem 0.5rem;
            font-size: 0.875rem;
            border-left: 0;
        }
        
        .speech-btn-mini:hover {
            transform: translateY(-1px);
        }
        
        .speech-btn-mini.btn-danger {
            animation: mini-recording-pulse 1.5s infinite;
        }
        
        @keyframes mini-recording-pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.5); }
            70% { box-shadow: 0 0 0 5px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="d-flex justify-content-between align-items-center">
            <h2>SEO Content Generator - Prompt Builder</h2>
            <a href="/" class="btn btn-light">‚Üê Back to Spintax Generator</a>
        </div>
    </div>
    
    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{category}}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        {% if not updated_prompt %}
        
        <!-- AI Auto-Fill Section -->
        <div class="section">
            <h3 class="section-title">ü§ñ AI Auto-Fill (Quick Start)</h3>
            <p class="text-muted">Let AI fill in all the details for you! Just describe your business in a few sentences and we'll generate intelligent answers for all the questions below.</p>
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>AI-Powered Responses:</strong> This system uses Google's Gemini AI with specialized prompts for each question to generate contextual, industry-specific answers. Powered by advanced AI reasoning for accurate business analysis.
            </div>
            
            <form method="post">
                <div class="mb-3">
                    <label class="form-label">Describe Your Business</label>
                    <div class="input-group">
                        <textarea id="businessDescription" class="form-control" name="business_description" rows="4" placeholder="Example: ABC Marketing is a digital marketing agency in Austin, Texas. We specialize in SEO, social media marketing, and PPC advertising for small to medium businesses. We've been helping local businesses grow their online presence for over 5 years with personalized strategies and transparent reporting.">{{ business_description or '' }}</textarea>
                        <button type="button" id="speechBtn" class="btn btn-outline-primary" onclick="toggleSpeechRecognition()">
                            <i id="speechIcon" class="fas fa-microphone"></i>
                            <span id="speechText">Speak</span>
                        </button>
                    </div>
                    <div id="speechStatus" class="form-text text-muted mt-2" style="display: none;">
                        <i class="fas fa-circle text-danger me-1" id="recordingIndicator"></i>
                        <span id="statusText">Click "Speak" to start voice input</span>
                    </div>
                </div>
                <div class="text-center">
                    <button type="submit" name="action" value="ai_autofill" class="btn accent-btn btn-lg">ü§ñ Auto-Fill with AI</button>
                </div>
            </form>
        </div>

        <div class="text-center my-4">
            <span class="text-muted">‚Äî OR ‚Äî</span>
        </div>

        <!-- Cell Reference Mapping Section -->
        <div class="section">
            <h3 class="section-title">üìä Cell Reference Mapping</h3>
            <p class="text-muted">Define the Google Sheets cell references that will be used in your spintax formulas. This is required for generating location-specific content.</p>
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Important:</strong> Only the cell references you define here will be used in the generated formulas. Do not leave this blank if you want dynamic content.
            </div>
            <form method="post" id="cellMappingForm">
                <div class="mb-3">
                    <label class="form-label">Page Type</label>
                    <select class="form-select" name="page_type" id="pageTypeSelect" onchange="updateLivePreview()">
                        <option value="parent" {% if cell_mappings and cell_mappings.get('page_type') == 'parent' %}selected{% endif %}>Parent</option>
                        <option value="sibling" {% if cell_mappings and cell_mappings.get('page_type') == 'sibling' %}selected{% endif %}>Sibling</option>
                        <option value="last_sibling" {% if cell_mappings and cell_mappings.get('page_type') == 'last_sibling' %}selected{% endif %}>Last Sibling</option>
                    </select>
                    <div class="form-text">Select the type of page for internal linking logic.</div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Primary Keyword Cell</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="cell_reference" 
                                   placeholder="e.g., C3" 
                                   value="{{ cell_mappings.get('reference', '') if cell_mappings is defined else '' }}"
                                   oninput="updateLivePreview()">
                            <span class="input-group-text">Content Reference Cell</span>
                        </div>
                        <div class="form-text">Specify the cell for which this content is being generated (e.g., C3). This cell will be used to determine parent, sibling, and last sibling relationships for internal linking.</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Business Name Cell</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="cell_business_name" 
                                   placeholder="e.g., B2" 
                                   value="{{ cell_mappings.get('business_name', '') if cell_mappings is defined else '' }}"
                                   oninput="updateLivePreview()">
                            <span class="input-group-text">Business Name</span>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">City Cell</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="cell_city" 
                                   placeholder="e.g., C2" 
                                   value="{{ cell_mappings.get('city', '') if cell_mappings is defined else '' }}"
                                   oninput="updateLivePreview()">
                            <span class="input-group-text">City</span>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">State Cell</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="cell_state" 
                                   placeholder="e.g., D2" 
                                   value="{{ cell_mappings.get('state', '') if cell_mappings is defined else '' }}"
                                   oninput="updateLivePreview()">
                            <span class="input-group-text">State</span>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Phone Number Cell</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="cell_phone" 
                                   placeholder="e.g., E2" 
                                   value="{{ cell_mappings.get('phone', '') if cell_mappings is defined else '' }}"
                                   oninput="updateLivePreview()">
                            <span class="input-group-text">Phone</span>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Contact URL Cell</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="cell_contact_url" 
                                   placeholder="e.g., F2" 
                                   value="{{ cell_mappings.get('contact_url', '') if cell_mappings is defined else '' }}"
                                   oninput="updateLivePreview()">
                            <span class="input-group-text">Contact URL</span>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Additional Cell Mappings</label>
                    <textarea class="form-control" name="additional_cell_mappings" rows="3" 
                              placeholder="Enter additional cell mappings, one per line. Example:&#10;G2 = Zip Code&#10;H2 = County&#10;I2 = Service Radius"
                              oninput="updateLivePreview()">{{ cell_mappings.get('additional', '') if cell_mappings is defined else '' }}</textarea>
                    <div class="form-text">Optional: Define any additional cells you want to reference in your content.</div>
                </div>
            </form>
        </div>

        <!-- Manual Question Form -->
        <div class="section">
            <h3 class="section-title">üìù Manual Entry</h3>
            <p class="text-muted">Fill out the questions manually for complete control over your answers.</p>
        </div>

        <!-- Question Form -->
        <div class="row">
            <!-- Left Column: Questions -->
            <div class="col-lg-7 question-form-container">
                <form method="post" id="promptForm">
                    {% for section_key, section_data in seo_questions.items() %}
                    <div class="section">
                        <h3 class="section-title">{{ section_data.title }}</h3>
                        <div class="row">
                            {% for question_key, question_text in section_data.questions.items() %}
                            <div class="col-md-12 mb-3">
                                <label class="form-label">{{ question_text }}</label>
                                <div class="input-group">
                                    <textarea class="form-control question-textarea" 
                                              name="{{ section_key }}_{{ question_key }}" 
                                              data-section="{{ section_key }}" 
                                              data-question="{{ question_key }}"
                                              rows="3" 
                                              placeholder="Enter your answer here..."
                                              oninput="updateLivePreview()">{{ answers.get(section_key, {}).get(question_key, '') }}</textarea>
                                    <button type="button" class="btn btn-outline-secondary btn-sm speech-btn-mini" onclick="startQuestionSpeech(this)">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="text-center">
                        <button type="submit" name="action" value="generate_prompt" class="btn accent-btn btn-lg">Generate Final Prompt</button>
                    </div>
                </form>
            </div>
            
            <!-- Right Column: Live Preview -->
            <div class="col-lg-5">
                <div class="live-preview-container">
                    <div class="position-relative">
                        <div class="preview-title">Your Generated Meta Prompt</div>
                        <button type="button" class="btn btn-sm copy-preview-btn" onclick="copyLivePreview()">
                            <i class="fas fa-copy"></i>
                        </button>
                        <div id="livePreview" class="live-preview">
SEO Content Generation Prompt

(Start filling out the form fields above to see your custom SEO content prompt appear here...)

This prompt will help you generate:
‚Ä¢ Website copy and landing pages
‚Ä¢ Blog posts and articles  
‚Ä¢ Meta descriptions and titles
‚Ä¢ Social media content
‚Ä¢ Ad copy and marketing materials

All optimized for search engines and your target audience.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        
        {% else %}
        <!-- Generated Prompt Output -->
        <div class="section">
            <h3 class="section-title">Your Updated Prompt</h3>
            <p class="text-muted">Copy the prompt below and use it with your AI assistant to generate comprehensive SEO content templates.</p>
            
            <div class="prompt-container">
                <div class="prompt-output">
                    <button type="button" class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyPrompt()">Copy Prompt</button>
                    <pre id="promptText" style="white-space: pre-wrap; margin-bottom: 0;">{{ updated_prompt }}</pre>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <a href="/prompt-builder" class="btn btn-secondary nav-btn">‚Üê Edit Answers</a>
                <a href="/" class="btn accent-btn nav-btn">Use in Spintax Generator ‚Üí</a>
            </div>
        </div>
        
        <!-- Summary of Answers -->
        <div class="section">
            <h4 class="section-title">Your Answers Summary</h4>
            {% for section_key, section_data in seo_questions.items() %}
                {% if answers.get(section_key) %}
                <div class="mb-3">
                    <h5 class="text-primary">{{ section_data.title }}</h5>
                    <ul class="list-unstyled ms-3">
                        {% for question_key, question_text in section_data.questions.items() %}
                            {% if answers[section_key].get(question_key) %}
                            <li><strong>{{ question_text }}</strong><br>
                                <span class="text-muted">{{ answers[section_key][question_key] }}</span></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Inject answers as a JS variable for safe logic
      var answersFromServer = {{ answers|tojson|safe }};
    </script>
    <script>
        function copyPrompt() {
            const promptText = document.getElementById('promptText').textContent;
            navigator.clipboard.writeText(promptText).then(function() {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-success');
                
                setTimeout(function() {
                    btn.textContent = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');
                }, 2000);
            }).catch(function(err) {
                alert('Failed to copy prompt. Please select and copy manually.');
            });
        }
        document.addEventListener('DOMContentLoaded', function() {
            if (answersFromServer && Object.keys(answersFromServer).length > 0) {
                // Add visual indicators that AI filled the form
                const sections = document.querySelectorAll('.section');
                sections.forEach(function(section) {
                    const title = section.querySelector('.section-title');
                    if (title && !title.textContent.includes('Auto-Fill') && !title.textContent.includes('Manual Entry')) {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-success ms-2';
                        badge.textContent = 'AI Filled';
                        title.appendChild(badge);
                    }
                });

                // Scroll to the first question section
                const firstQuestionSection = document.querySelector('.section h3.section-title');
                if (firstQuestionSection && !firstQuestionSection.textContent.includes('Auto-Fill')) {
                    firstQuestionSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        });

        // Auto-resize textareas
        document.addEventListener('DOMContentLoaded', function() {
            const textareas = document.querySelectorAll('textarea');
            textareas.forEach(function(textarea) {
                function autoResize() {
                    textarea.style.height = 'auto';
                    textarea.style.height = textarea.scrollHeight + 'px';
                }
                
                textarea.addEventListener('input', autoResize);
                // Initial resize
                autoResize();
            });
        });

        // Speech Recognition Variables
        let recognition;
        let isRecording = false;
        let speechTimeout;

        // Initialize Speech Recognition
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                
                recognition.onstart = function() {
                    isRecording = true;
                    updateSpeechUI(true);
                    document.getElementById('statusText').textContent = 'Listening... Speak now!';
                    
                    // Auto-stop after 60 seconds of recording (increased from 30)
                    speechTimeout = setTimeout(() => {
                        stopSpeechRecognition();
                    }, 60000);
                };
                
                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    const textarea = document.getElementById('businessDescription');
                    const currentText = textarea.value;
                    
                    // If we have new final results, append them
                    if (finalTranscript) {
                        const processedText = addBasicPunctuation(finalTranscript.trim());
                        if (currentText && !currentText.endsWith(' ') && !currentText.endsWith('.')) {
                            textarea.value = currentText + ' ' + processedText;
                        } else {
                            textarea.value = currentText + processedText;
                        }
                        
                        // Auto-resize textarea
                        textarea.style.height = 'auto';
                        textarea.style.height = textarea.scrollHeight + 'px';
                    }
                    
                    // Show interim results in status
                    if (interimTranscript) {
                        document.getElementById('statusText').textContent = 'Hearing: "' + interimTranscript + '"';
                    } else if (finalTranscript) {
                        document.getElementById('statusText').textContent = 'Added: "' + finalTranscript.trim() + '"';
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    let errorMessage = 'Speech recognition error: ';
                    switch(event.error) {
                        case 'no-speech':
                            errorMessage += 'No speech detected. Try speaking louder.';
                            break;
                        case 'audio-capture':
                            errorMessage += 'No microphone found. Please check your microphone.';
                            break;
                        case 'not-allowed':
                            errorMessage += 'Microphone access denied. Please allow microphone access.';
                            break;
                        case 'network':
                            errorMessage += 'Network error. Please check your internet connection.';
                            break;
                        default:
                            errorMessage += event.error;
                    }
                    document.getElementById('statusText').textContent = errorMessage;
                    stopSpeechRecognition();
                };
                
                recognition.onend = function() {
                    isRecording = false;
                    updateSpeechUI(false);
                    if (speechTimeout) {
                        clearTimeout(speechTimeout);
                    }
                };
                
                return true;
            } else {
                document.getElementById('speechBtn').style.display = 'none';
                console.warn('Speech recognition not supported in this browser');
                return false;
            }
        }

        function toggleSpeechRecognition() {
            if (!recognition && !initSpeechRecognition()) {
                alert('Speech recognition is not supported in your browser. Please use Chrome, Edge, or Safari.');
                return;
            }
            
            if (isRecording) {
                stopSpeechRecognition();
            } else {
                startSpeechRecognition();
            }
        }

        function startSpeechRecognition() {
            document.getElementById('speechStatus').style.display = 'block';
            document.getElementById('statusText').textContent = 'Starting speech recognition...';
            recognition.start();
        }

        function stopSpeechRecognition() {
            if (recognition && isRecording) {
                recognition.stop();
            }
            isRecording = false;
            updateSpeechUI(false);
            document.getElementById('statusText').textContent = 'Speech recognition stopped.';
            
            setTimeout(() => {
                document.getElementById('speechStatus').style.display = 'none';
            }, 3000);
        }

        function updateSpeechUI(recording) {
            const btn = document.getElementById('speechBtn');
            const icon = document.getElementById('speechIcon');
            const text = document.getElementById('speechText');
            const indicator = document.getElementById('recordingIndicator');
            
            if (recording) {
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-danger');
                icon.classList.remove('fa-microphone');
                icon.classList.add('fa-stop');
                text.textContent = 'Stop';
                indicator.classList.remove('text-danger');
                indicator.classList.add('text-success');
                
                // Animate the recording indicator
                indicator.style.animation = 'pulse 1s infinite';
            } else {
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-outline-primary');
                icon.classList.remove('fa-stop');
                icon.classList.add('fa-microphone');
                text.textContent = 'Speak';
                indicator.classList.remove('text-success');
                indicator.classList.add('text-danger');
                indicator.style.animation = 'none';
            }
        }

        // Initialize speech recognition on page load
        document.addEventListener('DOMContentLoaded', function() {
            initSpeechRecognition();
            updateLivePreview(); // Initialize preview
        });

        // Live Preview Functions
        function updateLivePreview() {
            const formData = new FormData(document.getElementById('promptForm'));
            const cellFormData = new FormData(document.getElementById('cellMappingForm'));
            const answers = {};
            
            // Collect all form data from both forms
            for (let [key, value] of formData.entries()) {
                if (value.trim()) {
                    answers[key] = value.trim();
                }
            }
            
            // Also collect cell mapping data for preview
            for (let [key, value] of cellFormData.entries()) {
                if (value.trim()) {
                    answers[key] = value.trim();
                }
            }
            
            // Generate preview prompt
            let prompt = generatePreviewPrompt(answers);
            document.getElementById('livePreview').textContent = prompt;
        }
        
function generatePreviewPrompt(answers) {
    let prompt = "";
    let hasContent = false;
    let businessInfoSection = "";
    let seoSection = "";
    // Add business info from form fields
    // Always show the business name from the correct textarea field
    if (answers.business_info_business_name) {
        businessInfoSection += `**Business Name:** ${answers.business_info_business_name}\n`;
        hasContent = true;
    }
    // If the textarea is empty, fall back to the legacy field
    else if (answers.business_info_name) {
        businessInfoSection += `**Business Name:** ${answers.business_info_name}\n`;
        hasContent = true;
    }
    if (answers.business_info_industry) {
        businessInfoSection += `**Industry:** ${answers.business_info_industry}\n`;
        hasContent = true;
    }
    if (answers.business_info_location) {
        businessInfoSection += `**Location:** ${answers.business_info_location}\n`;
        hasContent = true;
    }
    if (answers.business_info_target_audience) {
        businessInfoSection += `**Target Audience:** ${answers.business_info_target_audience}\n`;
        hasContent = true;
    }
    if (answers.business_info_unique_selling_proposition) {
        businessInfoSection += `**Unique Selling Proposition:** ${answers.business_info_unique_selling_proposition}\n`;
        hasContent = true;
    }
    if (businessInfoSection) {
        prompt += "üìã **BUSINESS INFORMATION:**\n";
        prompt += businessInfoSection + "\n";
    }

    // Add services/products context
    if (answers.services_products_main_services) {
        prompt += `**Services/Products:** ${answers.services_products_main_services}\n`;
        hasContent = true;
    }
    if (answers.services_products_service_benefits) {
        prompt += `**Key Benefits:** ${answers.services_products_service_benefits}\n`;
        hasContent = true;
    }
    if (answers.services_products_service_area) {
        prompt += `**Service Area:** ${answers.services_products_service_area}\n`;
        hasContent = true;
    }
    if (answers.services_products_pricing_model) {
        prompt += `**Pricing Model:** ${answers.services_products_pricing_model}\n`;
        hasContent = true;
    }

    // Add SEO requirements
    if (answers.seo_content_primary_keywords) {
        seoSection += `**Primary Keywords:** ${answers.seo_content_primary_keywords}\n`;
        hasContent = true;
    }
    if (answers.seo_content_secondary_keywords) {
        seoSection += `**Secondary Keywords:** ${answers.seo_content_secondary_keywords}\n`;
        hasContent = true;
    }
    if (answers.seo_content_content_tone) {
        seoSection += `**Content Tone:** ${answers.seo_content_content_tone}\n`;
        hasContent = true;
    }
    if (answers.seo_content_content_length) {
        seoSection += `**Content Length:** ${answers.seo_content_content_length}\n`;
        hasContent = true;
    }
    if (answers.seo_content_call_to_action) {
        seoSection += `**Call to Action:** ${answers.seo_content_call_to_action}\n`;
        hasContent = true;
    }
    if (seoSection) {
        prompt += "\nüìà **SEO REQUIREMENTS:**\n";
        prompt += seoSection;
    }

    // Add competitive information
    if (answers.competitors_main_competitors || answers.competitors_competitive_advantage || answers.competitors_market_position) {
        let compSection = "";
        if (answers.competitors_main_competitors) {
            compSection += `**Main Competitors:** ${answers.competitors_main_competitors}\n`;
        }
        if (answers.competitors_competitive_advantage) {
            compSection += `**Competitive Advantages:** ${answers.competitors_competitive_advantage}\n`;
        }
        if (answers.competitors_market_position) {
            compSection += `**Market Position:** ${answers.competitors_market_position}\n`;
        }
        prompt += "\nüèÜ **COMPETITIVE CONTEXT:**\n";
        prompt += compSection;
        hasContent = true;
    }

    // Internal linking logic based on page type
    let pageType = answers.page_type || "parent";
    prompt += "üîó **Internal Linking Logic:**\n";
    if (pageType === "parent") {
        prompt += "- This is a parent page.\n";
        prompt += "- Link only to the first sibling page (one cell to the right and one cell down from the parent, using dynamic references).\n";
        prompt += "- Use the following Google Sheets formula to link to the first sibling page (one cell to the right and one cell down):\n";
        prompt += "\n";
        prompt += "    =IF(INDIRECT(ADDRESS(ROW()+1, COLUMN()+1))=\"\", \"\", \"<a href='/\" & LOWER(SUBSTITUTE(INDIRECT(ADDRESS(ROW()+1, COLUMN()+1)), \" \", \"-\")) & \"'>\" & INDIRECT(ADDRESS(ROW()+1, COLUMN()+1)) & \"</a>\")\n";
        prompt += "  (This formula dynamically links to the first sibling page by referencing the cell one row down and one column to the right.)\n";
        prompt += "- Include breadcrumb navigation by concatenating parent and first sibling cell values dynamically:\n";
        prompt += "\n";
        prompt += "    =A1 & \" > \" & INDIRECT(ADDRESS(ROW()+1, COLUMN()+1))\n";
        prompt += "- Use anchor text with target keywords and location.\n";
        prompt += "- The Content Reference Cell determines which sibling cell is linked from this parent page.\n";
    } else if (pageType === "sibling") {
        prompt += "- This is a sibling page.\n";
        prompt += "- Link to the page one cell below this sibling page (using dynamic references).\n";
        prompt += "- Also link to the parent page (the cell one column to the left, and as many rows up as necessary until you find a cell with content).\n";
        prompt += "- Use the following Google Sheets formulas to generate the links dynamically:\n";
        prompt += "\n";
        prompt += "    // Link to next sibling page\n";
        prompt += "    =IF(INDIRECT(ADDRESS(ROW()+1, COLUMN()))=\"\",\"\",\"<a href='/\" & LOWER(SUBSTITUTE(INDIRECT(ADDRESS(ROW()+1, COLUMN())), \" \", \"-\")) & \"'>\" & INDIRECT(ADDRESS(ROW()+1, COLUMN())) & \"</a>\")\n";
        prompt += "    // Link to parent page (dynamic lookup one column left, up to first non-empty cell above)\n";
        prompt += "    =IFERROR(IF(INDEX(INDIRECT(CHAR(COLUMN()+64-1)&\"1:\"&CHAR(COLUMN()+64-1)&ROW()-1), MAX(FILTER(ROW(INDIRECT(\"1:\"&ROW()-1)), INDIRECT(CHAR(COLUMN()+64-1)&ROW(INDIRECT(\"1:\"&ROW()-1)))<>\"\")))=\"\",\"\",\"<a href='/\" & LOWER(SUBSTITUTE(INDEX(INDIRECT(CHAR(COLUMN()+64-1)&\"1:\"&CHAR(COLUMN()+64-1)&ROW()-1), MAX(FILTER(ROW(INDIRECT(\"1:\"&ROW()-1)), INDIRECT(CHAR(COLUMN()+64-1)&ROW(INDIRECT(\"1:\"&ROW()-1)))<>\"\"))), \" \", \"-\")) & \"'>\" & INDEX(INDIRECT(CHAR(COLUMN()+64-1)&\"1:\"&CHAR(COLUMN()+64-1)&ROW()-1), MAX(FILTER(ROW(INDIRECT(\"1:\"&ROW()-1)), INDIRECT(CHAR(COLUMN()+64-1)&ROW(INDIRECT(\"1:\"&ROW()-1)))<>\"\"))) & \"</a>\"),\"\")\n";
        prompt += "  (This formula uses INDEX, FILTER, and MAX to find the closest non-empty cell above in the column to the left.)\n";
        prompt += "- Include breadcrumb navigation by concatenating parent and sibling cell values dynamically:\n";
        prompt += "\n";
        prompt += "    =INDIRECT(ADDRESS(ROW()-1, COLUMN())) & \" > \" & INDIRECT(ADDRESS(ROW(),COLUMN()))\n";
        prompt += "- Use anchor text with target keywords and location.\n";
        prompt += "- The Content Reference Cell determines which sibling cell is linked from this page.\n";
    } else if (pageType === "last_sibling") {
        prompt += "- This is the last sibling page.\n";
        prompt += "- Link to the parent page using a dynamic reference (e.g., the cell above and to the left, or as mapped).\n";
        prompt += "- Also link to the parent page (the cell one column to the left, and as many rows up as necessary until you find a cell with content).\n";
        prompt += "- Use the following Google Sheets formulas to dynamically link to the parent page:\n";
        prompt += "\n";
        prompt += "    // Link to parent page (dynamic lookup one column left, up to first non-empty cell)\n";
        prompt += "    =IFERROR(IF(INDEX(INDIRECT(CHAR(COLUMN()+64-1)&\"1:\"&CHAR(COLUMN()+64-1)&ROW()),MATCH(TRUE,INDEX(INDIRECT(CHAR(COLUMN()+64-1)&\"1:\"&CHAR(COLUMN()+64-1)&ROW())<>\"\",0),0))=\"\",\"\",\"<a href='/\" & LOWER(SUBSTITUTE(INDEX(INDIRECT(CHAR(COLUMN()+64-1)&\"1:\"&CHAR(COLUMN()+64-1)&ROW()),MATCH(TRUE,INDEX(INDIRECT(CHAR(COLUMN()+64-1)&\"1:\"&CHAR(COLUMN()+64-1)&ROW())<>\"\",0),0)), \" \", \"-\")) & \"'>\" & INDEX(INDIRECT(CHAR(COLUMN()+64-1)&\"1:\"&CHAR(COLUMN()+64-1)&ROW()),MATCH(TRUE,INDEX(INDIRECT(CHAR(COLUMN()+64-1)&\"1:\"&CHAR(COLUMN()+64-1)&ROW())<>\"\",0),0)) & \"</a>\"),\"\")\n";
        prompt += "  (This formula uses INDEX and MATCH to find the first non-empty cell above in the column to the left.)\n";
        prompt += "- Link to all sibling pages except itself using a dynamic array formula:\n";
        prompt += "\n";
        prompt += "    =ARRAYFORMULA(IF((siblingRange<>\"\")*(siblingRange<>INDIRECT(ADDRESS(ROW(),COLUMN()))),\"<a href='/\" & LOWER(SUBSTITUTE(siblingRange, \" \", \"-\")) & \"'>\" & siblingRange & \"</a>\",\"\"))\n";
        prompt += "  (Replace siblingRange with the dynamic range of sibling cells; INDIRECT(ADDRESS(ROW(),COLUMN())) is the current cell.)\n";
        prompt += "- Do NOT link to itself.\n";
        prompt += "- Include breadcrumb navigation by concatenating parent and sibling cell values dynamically:\n";
        prompt += "\n";
        prompt += "    =INDIRECT(ADDRESS(ROW()-1, COLUMN()-1)) & \" > \" & INDIRECT(ADDRESS(ROW(),COLUMN()))\n";
        prompt += "- Use anchor text with target keywords and location.\n";
        prompt += "- The Content Reference Cell determines which parent and sibling cells are linked from this page.\n";
    }
    prompt += "\n";

    // ...rest of prompt-building logic (unchanged)...
    prompt += "\n‚úÖ **GENERATE 3 VERSIONS OF EACH:**\n";
    prompt += "- Fully spun article (800-1500 words after spinning)\n";
    prompt += "- Meta Title\n";
    prompt += "- Meta Description\n";
    prompt += "- Meta Keywords\n";
    prompt += "- FAQ Section\n";
    prompt += "- Schema Markup suggestions\n\n";

    prompt += "üßæ **REQUIREMENTS:**\n";
    prompt += "1. Use extensive spintax throughout all content (words, phrases, and sentences)\n";
    prompt += "2. Use nested spintax wherever possible\n";
    prompt += "3. Wrap everything in =SPINTAX_NESTED(CONCATENATE(...)) so it can be pasted into Google Sheets\n";
    prompt += "4. Use HTML tags for structure (e.g., <h1>, <h2>, <ul>, <p>)\n";
    prompt += "5. Only use the cell references provided above ‚Äî do not insert your own\n\n";

    prompt += "üìé **INTERNAL LINK FORMAT:**\n";
    prompt += "Include hyperlinks that build paths using:\n";
    prompt += "- The keyword + location fields (if provided)\n";
    prompt += "- Replace spaces with hyphens, all lowercase\n";
    prompt += "- Skip blank fields cleanly\n\n";

    prompt += "üß∑ **SAMPLE FORMULAS:**\n";
    prompt += "Hyperlink: =IF(Keyword=\"\", \"\", \"<a href='/\" & LOWER(SUBSTITUTE(JOIN(\"-\", FILTER({Keyword,City,State}, {Keyword,City,State} <> \"\")), \" \", \"-\")) & \"'>\" & \"Service in \" & TEXTJOIN(\", \", TRUE, FILTER({City,State}, {City,State} <> \"\")) & \"</a>\")\n\n";
    prompt += "Slug: =IF(Keyword=\"\", \"\", LOWER(SUBSTITUTE(JOIN(\"-\", FILTER({Keyword,City,State}, {Keyword,City,State} <> \"\")), \" \", \"-\")))\n\n";

    prompt += "üß© **SPINTAX EXAMPLES:**\n";
    prompt += "- Simple: `{granite|quartz|marble} counters`\n";
    prompt += "- Nested: `{Upgrade|{Transform|Elevate}|{Beautify|Enhance}} your kitchen`\n\n";

    prompt += "ÔøΩ ON-PAGE SEO OPTIMIZATION REQUIREMENTS:\n\n";
    prompt += "üìä **Keyword Optimization:**\n";
    prompt += "- Primary keyword density: 0.5-2.5% (natural integration, avoid stuffing)\n";
    prompt += "- Include primary keyword in: Title (beginning preferred), first 100 words, H1/H2 tags, meta description\n";
    prompt += "- Use keyword variations and synonyms throughout (LSI keywords)\n";
    prompt += "- Include location-based keyword combinations (e.g., '[service] in [city]', '[city] [service]')\n";
    prompt += "- Distribute secondary keywords naturally (0.5-1% density each)\n\n";
    prompt += "üìè **Content Structure & Length:**\n";
    prompt += "- Target 800-2000 words for main content (after spintax spinning)\n";
    prompt += "- Use proper heading hierarchy: H1 (main title), H2 (sections), H3 (subsections)\n";
    prompt += "- Include 3-5 H2 headings with target keywords\n";
    prompt += "- Create scannable content with bullet points, numbered lists, and short paragraphs (2-4 sentences)\n";
    prompt += "- Include FAQ section with question-based long-tail keywords\n\n";
    prompt += "üß† **NLP & Semantic SEO:**\n";
    prompt += "- Include topically related terms (TF-IDF relevant words)\n";
    prompt += "- Use entity-based keywords (people, places, organizations, concepts)\n";
    prompt += "- Answer 'People Also Ask' questions naturally in content\n";
    prompt += "- Include co-occurrence keywords (words that commonly appear with your main keyword)\n";
    prompt += "- Use semantic variations: synonyms, related terms, industry jargon\n";
    prompt += "- Include location-specific entities and landmarks where relevant\n\n";
    prompt += "üéØ **Content Quality Signals:**\n";
    prompt += "- Include expertise indicators: years of experience, certifications, awards\n";
    prompt += "- Add specific details: exact numbers, statistics, case studies\n";
    prompt += "- Include process descriptions and 'how-to' elements\n";
    prompt += "- Reference local information: area codes, zip codes, neighborhood names\n";
    prompt += "- Add social proof: testimonials, reviews, client mentions\n";
    prompt += "- Include contact information and business hours\n\n";
    prompt += "üîó **Internal Linking Strategy:**\n";
    prompt += "- 2-5 internal links per 1000 words\n";
    prompt += "- Use descriptive anchor text with target keywords\n";
    prompt += "- Link to related services, location pages, and cornerstone content\n";
    prompt += "- Include breadcrumb-style navigation cues\n";
    prompt += "- Cross-link between city/location pages\n\n";
    prompt += "üì± **Technical SEO Elements:**\n";
    prompt += "- Include schema markup opportunities (LocalBusiness, Service, FAQ)\n";
    prompt += "- Optimize for featured snippets: numbered lists, tables, definitions\n";
    prompt += "- Include image alt text suggestions with keywords\n";
    prompt += "- Add social media meta tags (Open Graph, Twitter Cards)\n";
    prompt += "- Include canonical URL structure\n\n";
    prompt += "üèÜ **User Experience Optimization:**\n";
    prompt += "- Front-load important information in first 100 words\n";
    prompt += "- Include clear calls-to-action every 200-300 words\n";
    prompt += "- Use action-oriented language and urgency triggers\n";
    prompt += "- Add trust signals: guarantees, licenses, insurance mentions\n";
    prompt += "- Include contact forms and phone numbers prominently\n\n";
    prompt += "üìç **Local SEO Factors:**\n";
    prompt += "- Include NAP (Name, Address, Phone) consistently\n";
    prompt += "- Reference local landmarks, neighborhoods, and areas served\n";
    prompt += "- Include 'near me' and location-based long-tail keywords\n";
    prompt += "- Add local business categories and service area descriptions\n";
    prompt += "- Include driving directions or service radius information\n\n";
    prompt += "‚ö° **Page Speed & Performance:**\n";
    prompt += "- Optimize content length for fast loading\n";
    prompt += "- Use efficient HTML structure\n";
    prompt += "- Include lazy loading attributes for images\n";
    prompt += "- Minimize excessive spintax that could slow processing\n\n";
    prompt += "üìà **Conversion Optimization:**\n";
    prompt += "- Include multiple contact methods (phone, form, email, chat)\n";
    prompt += "- Add urgency and scarcity elements where appropriate\n";
    prompt += "- Include benefit-focused headlines and subheadings\n";
    prompt += "- Use power words and emotional triggers\n";
    prompt += "- Add clear next steps and process explanations\n\n";
    prompt += "ÔøΩ IMPORTANT OUTPUT INSTRUCTIONS:\n";
    prompt += "For every output section, place the content inside its own separate code block. For example:\n";
    prompt += "- Place all 3 spun article versions inside one code block labeled 'Article Versions'\n";
    prompt += "- Place all 3 meta titles inside their own code block labeled 'Meta Titles'\n";
    prompt += "- Place all 3 meta descriptions inside their own code block labeled 'Meta Descriptions'\n";
    prompt += "- Place all 3 meta keywords inside their own code block labeled 'Meta Keywords'\n";
    prompt += "- Place schema markup suggestions inside their own code block labeled 'Schema Markup'\n";
    prompt += "- Place FAQ section inside its own code block labeled 'FAQ Section'\n";
    prompt += "- Place the internal link formula inside its own code block labeled 'Internal Link Formula'\n";
    prompt += "- Place the URL slug formula inside its own code block labeled 'URL Slug Formula'\n\n";
    prompt += "This will help the user easily copy each section independently.\n\n";
    prompt += "‚úÖ When complete:\n";
    prompt += "- Output all content in proper Google Sheets-ready formula format using SPINTAX_NESTED\n";
    prompt += "- Include internal links using the mapped keyword/city/state\n";
    prompt += "- Provide the slug formula for dynamic URL generation\n";
    prompt += "- Use **only** the cell references explicitly provided by the user\n";
    prompt += "- Ensure all SEO optimization factors are naturally integrated throughout the content\n";
    prompt += "- Include keyword density tracking and semantic keyword suggestions";

    // If no content was added, show the default prompt
    if (!hasContent) {
        return `SEO Content Generation Prompt

(Start filling out the form fields above to see your custom SEO content prompt appear here...)

This prompt will help you generate:
‚Ä¢ Website copy and landing pages
‚Ä¢ Blog posts and articles  
‚Ä¢ Meta descriptions and titles
‚Ä¢ Social media content
‚Ä¢ Ad copy and marketing materials

All optimized for search engines and your target audience.`;
    }

    return prompt;
}
        
        function copyLivePreview() {
            const previewText = document.getElementById('livePreview').textContent;
            navigator.clipboard.writeText(previewText).then(function() {
                const btn = document.querySelector('.copy-preview-btn');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.classList.add('btn-success');
                btn.classList.remove('copy-preview-btn');
                
                setTimeout(function() {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('btn-success');
                    btn.classList.add('copy-preview-btn');
                }, 2000);
            }).catch(function(err) {
                alert('Failed to copy preview. Please select and copy manually.');
            });
        }

        // Function to add basic punctuation to speech text
        function addBasicPunctuation(text) {
            if (!text) return text;
            
            // Trim and capitalize first letter
            text = text.trim();
            if (text.length > 0) {
                text = text.charAt(0).toUpperCase() + text.slice(1);
            }
            
            // Add commas for common speech patterns
            text = text.replace(/\b(and|but|so|however|therefore|meanwhile|furthermore|moreover|additionally|also|plus|besides)\b/gi, ', $1');
            text = text.replace(/\b(first|second|third|finally|lastly|next|then|after that|in addition|for example|such as)\b/gi, ', $1');
            text = text.replace(/\b(yes|no|well|okay|alright|actually|basically|honestly|frankly|obviously|clearly)\b/gi, '$1,');
            
            // Add commas for lists (word and word and word -> word, word, and word)
            text = text.replace(/(\w+)\s+and\s+(\w+)\s+and\s+(\w+)/g, '$1, $2, and $3');
            text = text.replace(/(\w+)\s+or\s+(\w+)\s+or\s+(\w+)/g, '$1, $2, or $3');
            
            // Add question marks for obvious questions
            text = text.replace(/^(what|how|when|where|why|who|which|can|could|would|should|is|are|do|does|did)\b.*(?![.!?])/gi, function(match) {
                return match + '?';
            });
            
            // Clean up double commas and spaces
            text = text.replace(/,\s*,/g, ',');
            text = text.replace(/\s+/g, ' ');
            text = text.replace(/,\s*\./g, '.');
            
            // Add period at the end if no punctuation exists
            if (text.length > 0 && !/[.!?]$/.test(text)) {
                text += '.';
            }
            
            // Capitalize after sentence endings
            text = text.replace(/([.!?]\s+)([a-z])/g, function(match, p1, p2) {
                return p1 + p2.toUpperCase();
            });
            
            return text;
        }

        // Quick speech function for individual questions
        let currentQuestionRecognition = null;
        let currentQuestionButton = null;

        function startQuestionSpeech(button) {
            // If already recording with this button, stop it
            if (currentQuestionRecognition && currentQuestionButton === button) {
                currentQuestionRecognition.stop();
                return;
            }

            // Stop any existing recognition
            if (currentQuestionRecognition) {
                currentQuestionRecognition.stop();
            }

            const textarea = button.previousElementSibling;
            currentQuestionButton = button;
            
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                currentQuestionRecognition = new SpeechRecognition();
                
                currentQuestionRecognition.continuous = true;
                currentQuestionRecognition.interimResults = true;
                currentQuestionRecognition.lang = 'en-US';
                
                let questionSpeechTimeout = null;
                
                currentQuestionRecognition.onstart = function() {
                    button.classList.remove('btn-outline-secondary');
                    button.classList.add('btn-danger');
                    button.innerHTML = '<i class="fas fa-stop"></i>';
                    button.disabled = false; // Keep button enabled so it can be clicked to stop
                };
                
                currentQuestionRecognition.onresult = function(event) {
                    // Clear existing timeout
                    if (questionSpeechTimeout) {
                        clearTimeout(questionSpeechTimeout);
                    }
                    
                    let finalTranscript = '';
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    // Only append final results to avoid duplicates
                    if (finalTranscript) {
                        const processedText = addBasicPunctuation(finalTranscript.trim());
                        if (textarea.value && !textarea.value.endsWith(' ') && !textarea.value.endsWith('.')) {
                            textarea.value += ' ' + processedText;
                        } else {
                            textarea.value += processedText;
                        }
                        
                        // Auto-resize textarea
                        textarea.style.height = 'auto';
                        textarea.style.height = textarea.scrollHeight + 'px';
                        
                        // Update live preview
                        updateLivePreview();
                    }
                    
                    // Set 8-second timeout after last speech detected
                    questionSpeechTimeout = setTimeout(() => {
                        if (currentQuestionRecognition) {
                            currentQuestionRecognition.stop();
                        }
                    }, 8000);
                };
                
                currentQuestionRecognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    if (questionSpeechTimeout) {
                        clearTimeout(questionSpeechTimeout);
                    }
                    resetQuestionSpeechButton();
                };
                
                currentQuestionRecognition.onend = function() {
                    if (questionSpeechTimeout) {
                        clearTimeout(questionSpeechTimeout);
                    }
                    resetQuestionSpeechButton();
                };
                
                currentQuestionRecognition.start();
                
                // Auto-stop after 30 seconds (increased from 10)
                setTimeout(() => {
                    if (currentQuestionRecognition) {
                        currentQuestionRecognition.stop();
                    }
                }, 30000);
            } else {
                alert('Speech recognition is not supported in your browser.');
            }
        }

        function resetQuestionSpeechButton() {
            if (currentQuestionButton) {
                currentQuestionButton.classList.remove('btn-danger');
                currentQuestionButton.classList.add('btn-outline-secondary');
                currentQuestionButton.innerHTML = '<i class="fas fa-microphone"></i>';
                currentQuestionButton.disabled = false;
                currentQuestionButton = null;
            }
            currentQuestionRecognition = null;
        }
    </script>
</body>
</html>
