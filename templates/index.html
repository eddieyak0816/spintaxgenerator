<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spintax Template Generator for Google Sheets</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f7f7fa; }
        .header { background: #1E2E66; color: #fff; padding: 1.5rem 2rem; margin-bottom: 2rem; }
        .nav-tabs .nav-link.active { background: #eaf3fb; border-color: #eaf3fb #eaf3fb #fff; color: #1E2E66; font-weight: bold; }
        .nav-tabs .nav-link { color: #1E2E66; }
        .section { background: #eaf3fb; border-radius: 8px; padding: 2rem; margin-bottom: 2rem; border: 1px solid #d0d7e5; }
        .accent-btn { background: #1E2E66; color: #fff; font-weight: bold; }
        .accent-btn:hover { background: #16204a; color: #fff; }
        .form-label { font-weight: 500; }
        .list-group-item { font-family: 'Segoe UI', sans-serif; }
        .tab-content { margin-top: 2rem; }
        .form-check-input:checked { background-color: #1E2E66; border-color: #1E2E66; }
    </style>
</head>
<body>
    <div class="header">
        <div class="d-flex justify-content-between align-items-center">
            <h2>Spintax Template Generator for Google Sheets</h2>
            <a href="/prompt-builder" class="btn btn-light">SEO Prompt Builder →</a>
        </div>
    </div>
    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{category}}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if tab=='variables' %}active{% endif %}" id="variables-tab" data-bs-toggle="tab" href="#variables" role="tab">Variables</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if tab=='template' %}active{% endif %}" id="template-tab" data-bs-toggle="tab" href="#template" role="tab">Template</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if tab=='prompts' %}active{% endif %}" id="prompts-tab" data-bs-toggle="tab" href="#prompts" role="tab">Template Manager</a>
            </li>
        </ul>
        <div class="tab-content">
            <!-- Variables Tab -->
            <div class="tab-pane fade {% if tab=='variables' %}show active{% endif %}" id="variables" role="tabpanel">
                <form method="post" class="section">
                    <input type="hidden" name="variables_json" value='{{ variables|tojson }}'>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Variable Name</label>
                            <input type="text" class="form-control" name="var_name" placeholder="e.g. product">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Cell Reference</label>
                            <input type="text" class="form-control" name="var_cell" placeholder="e.g. B2">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" name="action" value="add_variable" class="btn accent-btn w-100">Add Variable</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Variables List</label>
                        <ul class="list-group">
                            {% for var, cell in variables.items() %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>{{ var }} → {{ cell }}</span>
                                <button type="submit" name="action" value="remove_variable" name="remove_var_btn" class="btn btn-sm btn-outline-danger" onclick="document.getElementById('remove_var').value='{{ var }}'">Remove</button>
                            </li>
                            {% endfor %}
                        </ul>
                        <input type="hidden" id="remove_var" name="remove_var">
                    </div>
                    <button type="submit" name="action" value="clear_variables" class="btn btn-secondary">Clear All Variables</button>
                </form>
            </div>
            <!-- Template Tab -->
            <div class="tab-pane fade {% if tab=='template' %}show active{% endif %}" id="template" role="tabpanel">
                <form method="post" class="section" id="templateForm">
                    <input type="hidden" name="variables_json" value='{{ variables|tojson }}'>
                    <div class="mb-3">
                        <label class="form-label">Main Keyword</label>
                        <input type="text" class="form-control" name="main_keyword" value="{{ main_keyword }}" placeholder="e.g. Windows">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Template List</label>
                        <select class="form-select" name="selected_template" onchange="var f=this.form; var a=document.createElement('input'); a.type='hidden'; a.name='action'; a.value='load_template'; f.appendChild(a); f.submit(); f.removeChild(a);">
                            <option value="">-- Select Template --</option>
                            {% for name in prompts.keys() %}
                            <option value="{{ name }}" {% if selected_template==name %}selected{% endif %}>{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label">Spintax Template Options</label>
                            <button type="button" class="btn btn-sm btn-success" onclick="addTemplateOption()">+ Add Option</button>
                        </div>
                        <div id="templateOptions">
                            {% for i in range(template_options|length) %}
                            <div class="template-option mb-2" data-index="{{ i }}">
                                <div class="input-group">
                                    <span class="input-group-text">{{ i + 1 }}</span>
                                    <textarea class="form-control" name="template_option_{{ i }}" rows="3" placeholder="Enter spintax template option {{ i + 1 }}">{{ template_options[i] if template_options[i] else '' }}</textarea>
                                    {% if i > 0 %}
                                    <button type="button" class="btn btn-outline-danger" onclick="removeTemplateOption(this)">✕</button>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                            {% if template_options|length == 0 %}
                            <div class="template-option mb-2" data-index="0">
                                <div class="input-group">
                                    <span class="input-group-text">1</span>
                                    <textarea class="form-control" name="template_option_0" rows="3" placeholder="Enter spintax template option 1"></textarea>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="form-text">Tip: Use variable names like {{'{{City}}'}} in your templates. Cell references (e.g., A1) are for formula output only.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sample Values for Preview</label>
                        <div class="row">
                            {% for var in variables.keys() %}
                            <div class="col-md-3 mb-2">
                                <input type="text" class="form-control" name="sample_{{ var }}" placeholder="Sample for {{ var }}" value="{{ sample_values.get(var, '') }}">
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <button type="submit" name="action" value="preview" class="btn accent-btn">Preview with Sample Values</button>
                        <button type="submit" name="action" value="generate_formula" class="btn btn-primary">Generate Formula</button>
                        <button type="submit" name="action" value="clear_template" class="btn btn-secondary">Clear Templates</button>
                        <button type="button" class="btn btn-info" onclick="refreshPreview()">Refresh Sample</button>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Combined Formula Preview</label>
                        <textarea class="form-control" rows="4" readonly>{{ formula }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sample Output Preview</label>
                        <textarea class="form-control" rows="4" readonly>{{ preview }}</textarea>
                    </div>
                </form>
            </div>
            <!-- Template Manager Tab -->
            <div class="tab-pane fade {% if tab=='prompts' %}show active{% endif %}" id="prompts" role="tabpanel">
                <form method="post" class="section">
                    <input type="hidden" name="tab" value="prompts">
                    <input type="hidden" name="variables_json" value='{{ variables|tojson }}'>
                    <!-- Include current template options as hidden fields -->
                    {% for i in range(template_options|length) %}
                    <input type="hidden" name="template_option_{{ i }}" value="{{ template_options[i] if template_options[i] else '' }}">
                    {% endfor %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Template List</label>
                            <select class="form-select" name="prompt_name" onchange="var f=this.form; var a=document.createElement('input'); a.type='hidden'; a.name='action'; a.value='load_prompt'; f.appendChild(a); f.submit(); f.removeChild(a);">
                                <option value="">-- Select Template --</option>
                                {% for name in prompts.keys() %}
                                <option value="{{ name }}" {% if prompt_name==name %}selected{% endif %}>{{ name }}</option>
                                {% endfor %}
                            </select>
                            <!-- No hidden action field; JS sets action for dropdown only -->
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Template Name</label>
                            <input type="text" class="form-control" name="new_prompt_name" placeholder="Enter new template name" value="{{ new_prompt_name if new_prompt_name is defined else '' }}">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Template Options Preview</label>
                        <div class="alert alert-info">
                            <strong>Current Template Options ({{ template_options|length }}):</strong>
                            {% if template_options and template_options[0] %}
                                {% for option in template_options %}
                                <div class="mt-2"><strong>Option {{ loop.index }}:</strong> {{ option[:100] }}{% if option|length > 100 %}...{% endif %}</div>
                                {% endfor %}
                            {% else %}
                                <div class="mt-2">No template options defined. Go to the Template tab to create options.</div>
                            {% endif %}
                        </div>
                        <div class="form-text">Template options from the Template tab will be saved together. Saving will store all current template options as a single template.</div>
                    </div>
                    <div class="mb-3">
                        <button type="submit" name="action" value="save_prompt" class="btn accent-btn">Save Current Template Options</button>
                        <button type="submit" name="action" value="delete_prompt" class="btn btn-danger">Delete Selected Template</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Tab navigation on submit
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function(e) {
                let tab = this.closest('.tab-pane').id;
                if (tab) {
                    let url = new URL(window.location);
                    url.searchParams.set('tab', tab);
                    this.action = url.pathname + url.search;
                }
            });
        });

        // Remove variable button sets hidden input
        document.querySelectorAll('button[name="remove_var_btn"]').forEach(btn => {
            btn.addEventListener('click', function(e) {
                document.getElementById('remove_var').value = this.closest('li').querySelector('span').textContent.split('→')[0].trim();
            });
        });

        // No JS needed for prompt deletion; backend always uses dropdown value

        // Dynamic template options functions
        function addTemplateOption() {
            const container = document.getElementById('templateOptions');
            const currentOptions = container.querySelectorAll('.template-option');
            const newIndex = currentOptions.length;
            
            const newOption = document.createElement('div');
            newOption.className = 'template-option mb-2';
            newOption.setAttribute('data-index', newIndex);
            newOption.innerHTML = `
                <div class="input-group">
                    <span class="input-group-text">${newIndex + 1}</span>
                    <textarea class="form-control" name="template_option_${newIndex}" rows="3" placeholder="Enter spintax template option ${newIndex + 1}"></textarea>
                    <button type="button" class="btn btn-outline-danger" onclick="removeTemplateOption(this)">✕</button>
                </div>
            `;
            container.appendChild(newOption);
        }

        function removeTemplateOption(button) {
            const option = button.closest('.template-option');
            option.remove();
            updateTemplateIndexes();
        }

        function updateTemplateIndexes() {
            const options = document.querySelectorAll('.template-option');
            options.forEach((option, index) => {
                option.setAttribute('data-index', index);
                const span = option.querySelector('.input-group-text');
                const textarea = option.querySelector('textarea');
                const removeBtn = option.querySelector('.btn-outline-danger');
                
                span.textContent = index + 1;
                textarea.name = `template_option_${index}`;
                textarea.placeholder = `Enter spintax template option ${index + 1}`;
                
                // Hide remove button for first option
                if (index === 0) {
                    if (removeBtn) removeBtn.style.display = 'none';
                } else {
                    if (removeBtn) removeBtn.style.display = 'block';
                }
            });
        }

        function refreshPreview() {
            const form = document.getElementById('templateForm');
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'refresh_sample';
            form.appendChild(actionInput);
            form.submit();
        }

        // Initialize template indexes on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateTemplateIndexes();
        });
    </script>
</body>
</html>
